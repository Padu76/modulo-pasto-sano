        // Funzione per gestire pagamento completato con successo
        function handleSuccessfulPayment(method, details) {
            console.log(`Pagamento ${method} completato:`, details);
            
            // Messaggio di successo
            alert(`‚úÖ Pagamento completato con successo tramite ${method.toUpperCase()}!\n\nRiceverai una email di conferma a breve.`);
            
            // Chiudi modal
            if (cartModal) cartModal.style.display = 'none';
            
            // Svuota carrello dopo pagamento riuscito
            clearCart();
            
            // Mostra toast di successo
            showToast(`Pagamento ${method} completato! üéâ`);
            
            // Redirect alla pagina di successo (opzionale)
            // window.location.href = 'success.html';
        }<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasto Sano - Ordina i tuoi pasti</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Meta tags per social sharing -->
    <meta name="description" content="Pasto Sano - La soluzione per stare in forma. Ordina i tuoi pasti sani e gustosi con consegna a domicilio.">
    <meta property="og:title" content="Pasto Sano - La soluzione per stare in forma">
    <meta property="og:description" content="La soluzione per stare in forma con pasti sani e gustosi a domicilio">
    <meta property="og:image" content="logo.png">
    <meta property="og:type" content="website">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header con logo trasparente e testo affiancato -->
    <header class="header">
        <div class="header-content">
            <div class="brand-container">
                <img src="logo.png" alt="Pasto Sano" class="logo-transparent" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="brand-text">
                    <h1 class="brand-title">PASTO SANO</h1>
                    <p class="brand-subtitle">La soluzione per stare in forma</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Container principale -->
    <div class="container">
        <!-- Sezione Pasti Completi -->
        <section class="menu-section">
            <div class="section-header">
                <h2 class="section-title">Pasti Completi</h2>
                <div class="price-badge">8‚Ç¨ cad.</div>
            </div>
            
            <div class="products-grid" id="main-meals">
                <!-- I pasti verranno generati dinamicamente -->
            </div>
        </section>

        <!-- Sezione Colazioni -->
        <section class="menu-section">
            <div class="section-header">
                <h2 class="section-title">Colazioni</h2>
                <div class="price-badge">6‚Ç¨ cad.</div>
            </div>
            
            <div class="products-grid" id="breakfast-meals">
                <!-- Le colazioni verranno generate dinamicamente -->
            </div>
        </section>
    </div>

    <!-- Carrello floating -->
    <div class="floating-cart" id="floating-cart">
        <div class="cart-counter" id="cart-counter">0</div>
        <span>Carrello</span>
        <span id="cart-total">0.00‚Ç¨</span>
    </div>

    <!-- Modal carrello -->
    <div class="cart-modal" id="cart-modal">
        <div class="cart-content">
            <div class="cart-header">
                <h3>Il tuo Ordine</h3>
                <button class="close-btn" id="close-cart">&times;</button>
            </div>
            
            <div id="cart-items">
                <!-- Items del carrello -->
            </div>

            <!-- Sezione codice promozionale ridisegnata -->
            <div class="promo-section">
                <div class="promo-input-group">
                    <input type="text" class="promo-input" id="promo-code" placeholder="Codice promozionale">
                    <button class="promo-btn" id="apply-promo">Applica</button>
                </div>
                <div class="promo-message" id="promo-message"></div>
            </div>

            <div id="discount-display"></div>

            <div class="cart-total">
                <div style="font-size: 1.2rem; font-weight: 700; color: #2d5a2d;">
                    Totale: <span id="modal-total">0.00‚Ç¨</span>
                </div>
                <div style="color: #6c757d; margin-top: 0.25rem;">
                    <span id="total-items">0</span> articoli
                </div>
            </div>

            <div class="order-form">
                <!-- Sezione informazioni cliente -->
                <div class="customer-info-section">
                    <h4 style="color: #3f6844; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>üìù</span> Il tuo nome
                    </h4>
                    
                    <div class="form-group">
                        <label class="form-label" for="customer-name">Nome *</label>
                        <input type="text" class="form-input" id="customer-name" placeholder="Come ti chiami?" required>
                        <div class="form-note">
                            Cos√¨ possiamo identificare il tuo ordine pi√π facilmente
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="pickup-date">Data di Ritiro *</label>
                    <div class="date-input-wrapper" onclick="document.getElementById('pickup-date').showPicker()">
                        <input type="date" class="form-input date-input" id="pickup-date" required>
                        <div class="date-placeholder" id="date-placeholder">
                            <span class="calendar-icon">üìÖ</span>
                            <span class="placeholder-text">Seleziona la data di ritiro</span>
                        </div>
                    </div>
                    <div class="form-note">L'ordine deve essere effettuato con 2 giorni di anticipo</div>
                </div>

                <!-- Sezione metodo di pagamento -->
                <div class="payment-section">
                    <h4 style="color: #3f6844; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>üí≥</span> Metodo di Pagamento
                    </h4>
                    
                    <div class="payment-methods">
                        <div class="payment-method" data-method="stripe">
                            <div class="payment-icon">üí≥</div>
                            <div class="payment-info">
                                <div class="payment-title">Carta di Credito/Debito</div>
                                <div class="payment-subtitle">Visa, Mastercard, American Express</div>
                            </div>
                            <div class="payment-radio">
                                <input type="radio" name="payment" value="stripe" id="payment-stripe">
                            </div>
                        </div>

                        <div class="payment-method" data-method="paypal">
                            <div class="payment-icon">üÖøÔ∏è</div>
                            <div class="payment-info">
                                <div class="payment-title">PayPal</div>
                                <div class="payment-subtitle">Paga con il tuo account PayPal</div>
                            </div>
                            <div class="payment-radio">
                                <input type="radio" name="payment" value="paypal" id="payment-paypal">
                            </div>
                        </div>

                        <div class="payment-method" data-method="cash" data-selected="true">
                            <div class="payment-icon">üí∞</div>
                            <div class="payment-info">
                                <div class="payment-title">Contanti alla Consegna</div>
                                <div class="payment-subtitle">Paga quando ritiri l'ordine</div>
                            </div>
                            <div class="payment-radio">
                                <input type="radio" name="payment" value="cash" id="payment-cash" checked>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-primary" id="confirm-order">
                    <span id="order-button-text">üì± Invia su WhatsApp</span>
                    <div class="spinner" id="loading-spinner" style="display: none;"></div>
                </button>
                
                <!-- Container per i bottoni PayPal (nascosto inizialmente) -->
                <div id="paypal-button-container" style="display: none; margin-bottom: 10px;"></div>
                
                <!-- Form Stripe semplificato (nascosto inizialmente) -->
                <div id="stripe-payment-form" style="display: none; margin-bottom: 15px;">
                    <div style="background: #f0f7f0; padding: 15px; border-radius: 8px; border: 1px solid #7a9e7e;">
                        <p style="margin: 0; color: #2d5a2d; font-weight: 600;">
                            üí≥ Pagamento sicuro con Stripe
                        </p>
                        <p style="margin: 8px 0 0 0; color: #718096; font-size: 0.9rem;">
                            Sarai reindirizzato alla pagina sicura di Stripe per completare il pagamento
                        </p>
                    </div>
                </div>
                
                <button class="btn-secondary" id="clear-cart">Svuota</button>
            </div>
        </div>
    </div>

    <!-- Toast per notifiche -->
    <div class="toast" id="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    
    <!-- Stripe SDK -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=ATRYKexpKZq-EFO0jpNzElUuJaeQ1qE9qHhGIRbcAgra5--Wd6_2OkJEt5odzNu2obNQUnmQdnJYu7aD&currency=EUR&components=buttons"></script>
    
    <script src="script.js"></script>

    <style>
    /* Header con logo trasparente via CSS */
    .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        border-bottom: 1px solid rgba(122, 158, 126, 0.2);
    }

    .header-content {
        display: flex;
        align-items: center;
        justify-content: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .brand-container {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    /* CSS SEMPLIFICATO PER LOGO TRASPARENTE! */
    .logo-transparent {
        height: 80px;
        width: auto;
        object-fit: contain;
        transition: transform 0.3s ease;
        /* Gi√† trasparente, non servono filtri! */
    }

    .logo-transparent:hover {
        transform: scale(1.05);
    }

    .brand-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .brand-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2d5a2d;
        margin: 0;
        line-height: 0.9;
        letter-spacing: -1px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .brand-subtitle {
        font-size: 1rem;
        color: #ff6b35;
        margin: 4px 0 0 0;
        font-weight: 600;
        font-style: italic;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Stili per la sezione informazioni cliente */
    .customer-info-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #7a9e7e;
        border: 1px solid #e9ecef;
    }

    .customer-info-section h4 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #2d3748;
        font-size: 0.95rem;
    }

    .form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: white;
    }

    .form-input:focus {
        outline: none;
        border-color: #7a9e7e;
        box-shadow: 0 0 0 3px rgba(122, 158, 126, 0.1);
    }

    .form-input:required {
        border-color: #cbd5e0;
    }

    .form-input:invalid:not(:placeholder-shown) {
        border-color: #e53e3e;
    }

    .form-input:valid {
        border-color: #38a169;
    }

    /* Stili migliorati per il campo data */
    .date-input-wrapper {
        position: relative;
        cursor: pointer;
    }

    .date-input {
        position: relative;
        z-index: 2;
        color: transparent;
        background: transparent;
    }

    .date-input::-webkit-calendar-picker-indicator {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: auto;
        height: auto;
        color: transparent;
        background: transparent;
        cursor: pointer;
        z-index: 3;
    }

    .date-input:focus {
        color: #2d3748;
    }

    .date-input:valid {
        color: #2d3748;
    }

    .date-placeholder {
        position: absolute;
        top: 50%;
        left: 12px;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        gap: 8px;
        pointer-events: none;
        color: #a0aec0;
        font-size: 16px;
        z-index: 1;
        transition: opacity 0.2s;
    }

    .date-input:focus + .date-placeholder,
    .date-input:valid + .date-placeholder {
        opacity: 0;
    }

    .calendar-icon {
        font-size: 18px;
    }

    .placeholder-text {
        font-size: 16px;
    }

    .form-note {
        font-size: 0.85rem;
        color: #718096;
        margin-top: 5px;
        font-style: italic;
    }

    /* Stili per la sezione pagamenti */
    .payment-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #7a9e7e;
        border: 1px solid #e9ecef;
    }

    .payment-section h4 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .payment-methods {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .payment-method {
        display: flex;
        align-items: center;
        padding: 15px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .payment-method:hover {
        border-color: #7a9e7e;
        box-shadow: 0 2px 8px rgba(122, 158, 126, 0.1);
    }

    .payment-method[data-selected="true"] {
        border-color: #7a9e7e;
        background: #f0f7f0;
        box-shadow: 0 2px 8px rgba(122, 158, 126, 0.15);
    }

    .payment-icon {
        font-size: 2rem;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .payment-info {
        flex: 1;
    }

    .payment-title {
        font-weight: 600;
        color: #2d3748;
        font-size: 1rem;
        margin-bottom: 4px;
    }

    .payment-subtitle {
        font-size: 0.85rem;
        color: #718096;
    }

    .payment-radio {
        margin-left: 15px;
    }

    .payment-radio input[type="radio"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #7a9e7e;
    }

    /* Stili per i container di pagamento */
    #stripe-payment-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    #card-element {
        transition: border-color 0.2s ease;
    }

    #card-element:focus,
    #card-element.StripeElement--focus {
        border-color: #7a9e7e !important;
        box-shadow: 0 0 0 3px rgba(122, 158, 126, 0.1) !important;
    }

    #paypal-button-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    /* Stili responsive per i payment containers */
    @media (max-width: 768px) {
        #stripe-payment-form,
        #paypal-button-container {
            padding: 15px;
        }
    }

    /* Fix per floating cart che sborda - SEMPLIFICATO */
    .floating-cart {
        position: fixed !important;
        bottom: 1rem !important;
        right: 1rem !important;
        z-index: 1000 !important;
        max-width: 250px !important;
        cursor: pointer !important;
        pointer-events: auto !important;
        padding: 1.2rem 1.5rem !important;
        font-size: 1.1rem !important;
        min-height: 60px !important;
    }

    .floating-cart:hover {
        transform: translateY(-2px) !important;
    }

    .cart-counter {
        flex-shrink: 0 !important;
        width: 32px !important;
        height: 32px !important;
        font-size: 1rem !important;
    }

    /* Previeni scroll orizzontale SEMPLIFICATO */
    body {
        overflow-x: hidden !important;
    }

    html {
        overflow-x: hidden !important;
    }

    /* Responsive per mobile */
    @media (max-width: 768px) {
        .brand-container {
            gap: 15px;
        }
        
        .logo-transparent {
            height: 65px;
        }
        
        .brand-title {
            font-size: 1.8rem;
        }
        
        .brand-subtitle {
            font-size: 0.9rem;
        }

        .customer-info-section {
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .customer-info-section h4 {
            font-size: 1rem;
        }
        
        .form-input {
            padding: 10px;
            font-size: 16px;
        }

        .date-placeholder {
            left: 10px;
        }

        .placeholder-text, .calendar-icon {
            font-size: 16px;
        }

        /* Floating cart responsive SEMPLIFICATO */
        .floating-cart {
            bottom: 20px !important;
            right: 20px !important;
            max-width: 200px !important;
            pointer-events: auto !important;
            padding: 1rem 1.2rem !important;
            font-size: 1rem !important;
            min-height: 55px !important;
        }

        .cart-counter {
            width: 28px !important;
            height: 28px !important;
            font-size: 0.9rem !important;
        }
    }

    @media (max-width: 480px) {
        .brand-container {
            gap: 12px;
        }
        
        .logo-transparent {
            height: 60px;
        }
        
        .brand-title {
            font-size: 1.5rem;
        }
        
        .brand-subtitle {
            font-size: 0.8rem;
        }

        /* Floating cart mobile piccolo SEMPLIFICATO */
        .floating-cart {
            bottom: 15px !important;
            right: 15px !important;
            max-width: 170px !important;
            pointer-events: auto !important;
            padding: 0.9rem 1.1rem !important;
            font-size: 0.95rem !important;
            min-height: 50px !important;
        }

        .cart-counter {
            width: 26px !important;
            height: 26px !important;
            font-size: 0.85rem !important;
        }
    }
    </style>

    <script>
    <script>
    // Sistema carrello semplificato
    let cart = [];
    let cartTotal = 0;

    // Funzioni helper per il carrello
    function getTotalAmount() {
        return cartTotal;
    }

    function getCartItems() {
        return cart;
    }

    function updateCartDisplay() {
        const cartCounter = document.getElementById('cart-counter');
        const cartTotalElement = document.getElementById('cart-total');
        const modalTotal = document.getElementById('modal-total');
        const totalItems = document.getElementById('total-items');
        const cartItemsContainer = document.getElementById('cart-items');

        // Aggiorna contatori
        const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCounter.textContent = itemCount;
        cartTotalElement.textContent = cartTotal.toFixed(2) + '‚Ç¨';
        modalTotal.textContent = cartTotal.toFixed(2) + '‚Ç¨';
        totalItems.textContent = itemCount;

        // Aggiorna contenuto modal
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">Il carrello √® vuoto</div>';
        } else {
            cartItemsContainer.innerHTML = cart.map(item => `
                <div class="cart-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee;">
                    <div>
                        <div style="font-weight: 600; color: #2d5a2d;">${item.name}</div>
                        <div style="color: #6c757d; font-size: 0.9rem;">${item.price}‚Ç¨ x ${item.quantity} = ${(item.price * item.quantity).toFixed(2)}‚Ç¨</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="updateQuantity('${item.id}', -1)" style="background: #dc3545; color: white; border: none; border-radius: 4px; width: 30px; height: 30px; cursor: pointer;">-</button>
                        <span style="font-weight: 600;">${item.quantity}</span>
                        <button onclick="updateQuantity('${item.id}', 1)" style="background: #7a9e7e; color: white; border: none; border-radius: 4px; width: 30px; height: 30px; cursor: pointer;">+</button>
                    </div>
                </div>
            `).join('');
        }
    }

    function addToCart(name, price) {
        const id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
        const existingItem = cart.find(item => item.id === id);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                id: id,
                name: name,
                price: price,
                quantity: 1
            });
        }
        
        cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        updateCartDisplay();
        
        // Debug log
        console.log('Prodotto aggiunto:', name);
        console.log('Carrello aggiornato:', cart);
        console.log('Nuovo totale:', cartTotal);
        
        // Mostra toast
        showToast(`${name} aggiunto al carrello!`);
    }

    function updateQuantity(itemId, change) {
        const item = cart.find(item => item.id === itemId);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                cart = cart.filter(item => item.id !== itemId);
            }
        }
        
        cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        updateCartDisplay();
    }

    function clearCart() {
        cart = [];
        cartTotal = 0;
        updateCartDisplay();
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        toast.style.background = '#7a9e7e';
        toast.style.color = 'white';
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.padding = '12px 20px';
        toast.style.borderRadius = '8px';
        toast.style.zIndex = '9999';
        toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // Genera prodotti di esempio
    function generateProducts() {
        const products = [
            { name: "FUSILLI, MACINATO MANZO, ZUCCHINE, MELANZANE", price: 8 },
            { name: "ROASTBEEF, PATATE AL FORNO, FAGIOLINI", price: 8 },
            { name: "RISO, HAMBURGER MANZO, CAROTINE BABY", price: 8 },
            { name: "RISO NERO, GAMBERI, TONNO, PISELLI", price: 8 },
            { name: "PATATE, SALMONE GRIGLIATO, BROCCOLI", price: 8 },
            { name: "POLLO GRIGLIATO, PATATE AL FORNO, ZUCCHINE", price: 8 }
        ];

        const container = document.getElementById('main-meals');
        if (container) {
            container.innerHTML = products.map(product => `
                <div class="product-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s;">
                    <div style="height: 200px; background: linear-gradient(45deg, #f0f7f0, #e8f5e8); display: flex; align-items: center; justify-content: center; font-size: 3rem;">üçΩÔ∏è</div>
                    <div style="padding: 20px;">
                        <h3 style="color: #2d5a2d; font-size: 1rem; margin-bottom: 10px; font-weight: 600;">${product.name}</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <span style="font-size: 1.1rem; font-weight: 700; color: #2d5a2d;">${product.price}‚Ç¨</span>
                            <button onclick="addToCart('${product.name}', ${product.price})" style="background: #7a9e7e; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600;">Aggiungi al Carrello</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    // Script per migliorare l'esperienza del date picker
    document.addEventListener('DOMContentLoaded', function() {
        // Genera prodotti
        generateProducts();
        
        const dateInput = document.getElementById('pickup-date');
        const dateWrapper = dateInput?.closest('.date-input-wrapper');
        
        // Fallback per browser che non supportano showPicker()
        if (dateWrapper) {
            dateWrapper.addEventListener('click', function(e) {
                if (e.target === dateWrapper) {
                    if (dateInput.showPicker) {
                        try {
                            dateInput.showPicker();
                        } catch (error) {
                            dateInput.focus();
                            dateInput.click();
                        }
                    } else {
                        dateInput.focus();
                        dateInput.click();
                    }
                }
            });
        }

        // Gestisci il placeholder quando viene selezionata una data
        if (dateInput) {
            dateInput.addEventListener('change', function() {
                const placeholder = document.getElementById('date-placeholder');
                if (placeholder) {
                    if (this.value) {
                        placeholder.style.opacity = '0';
                    } else {
                        placeholder.style.opacity = '1';
                    }
                }
            });
        }

        // Gestione metodi di pagamento
        const paymentMethods = document.querySelectorAll('.payment-method');
        const orderButton = document.getElementById('confirm-order');
        const orderButtonText = document.getElementById('order-button-text');
        const stripeForm = document.getElementById('stripe-payment-form');
        const paypalContainer = document.getElementById('paypal-button-container');
        let currentPaymentMethod = 'cash';
        
        paymentMethods.forEach(method => {
            method.addEventListener('click', function() {
                // Rimuovi selezione da tutti
                paymentMethods.forEach(m => {
                    m.removeAttribute('data-selected');
                });
                
                // Aggiungi selezione al metodo cliccato
                this.setAttribute('data-selected', 'true');
                
                // Seleziona il radio button
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    currentPaymentMethod = radio.value;
                }
                
                // Nascondi tutti i form di pagamento
                if (stripeForm) stripeForm.style.display = 'none';
                if (paypalContainer) paypalContainer.style.display = 'none';
                
                // Aggiorna il testo del bottone
                if (orderButtonText) {
                    switch(currentPaymentMethod) {
                        case 'stripe':
                            orderButtonText.textContent = 'üí≥ Paga con Carta';
                            if (stripeForm) stripeForm.style.display = 'block';
                            break;
                        case 'paypal':
                            orderButtonText.textContent = 'üÖøÔ∏è Seleziona PayPal qui sotto';
                            if (paypalContainer) {
                                paypalContainer.style.display = 'block';
                                console.log('Mostrando container PayPal');
                                // Forza inizializzazione PayPal
                                setTimeout(() => {
                                    if (!paypalContainer.hasChildNodes() || paypalContainer.children.length === 0) {
                                        console.log('Inizializzando bottoni PayPal...');
                                        initPayPal();
                                    } else {
                                        console.log('Bottoni PayPal gi√† presenti');
                                    }
                                }, 500);
                            }
                            break;
                        case 'cash':
                            orderButtonText.textContent = 'üì± Invia su WhatsApp';
                            break;
                    }
                }
            });
        });
        
        // Gestione click bottone conferma ordine
        if (orderButton) {
            orderButton.addEventListener('click', async function(e) {
                e.preventDefault();
                
                // Validazione form
                const customerName = document.getElementById('customer-name')?.value;
                const pickupDate = document.getElementById('pickup-date')?.value;
                
                if (!customerName || !pickupDate) {
                    alert('Compila tutti i campi obbligatori');
                    return;
                }
                
                if (cart.length === 0) {
                    alert('Aggiungi almeno un prodotto al carrello');
                    return;
                }
                
                const spinner = document.getElementById('loading-spinner');
                if (spinner) spinner.style.display = 'inline-block';
                orderButton.disabled = true;
                
                try {
                    switch(currentPaymentMethod) {
                        case 'stripe':
                            alert('Pagamento con carta temporaneamente non disponibile. Ti contattiamo su WhatsApp.');
                            handleCashOrder();
                            break;
                        case 'paypal':
                            alert('Usa il bottone PayPal qui sopra per completare il pagamento');
                            break;
                        case 'cash':
                            handleCashOrder();
                            break;
                    }
                } catch (error) {
                    console.error('Errore durante il pagamento:', error);
                    alert('Errore durante il pagamento. Riprova.');
                } finally {
                    if (spinner) spinner.style.display = 'none';
                    orderButton.disabled = false;
                }
            });
        }
        
        // Gestione carrello floating
        const floatingCart = document.getElementById('floating-cart');
        const cartModal = document.getElementById('cart-modal');
        const closeCart = document.getElementById('close-cart');
        const clearCartBtn = document.getElementById('clear-cart');
        
        if (floatingCart && cartModal) {
            floatingCart.addEventListener('click', function() {
                cartModal.style.display = 'flex';
            });
        }
        
        if (closeCart && cartModal) {
            closeCart.addEventListener('click', function() {
                cartModal.style.display = 'none';
            });
        }
        
        if (clearCartBtn) {
            clearCartBtn.addEventListener('click', function() {
                if (confirm('Sei sicuro di voler svuotare il carrello?')) {
                    clearCart();
                }
            });
        }
        
        // Chiudi modal cliccando fuori
        if (cartModal) {
            cartModal.addEventListener('click', function(e) {
                if (e.target === cartModal) {
                    cartModal.style.display = 'none';
                }
            });
        }
        
        // Funzione per gestire ordine in contanti MIGLIORATA
        function handleCashOrder() {
            console.log('Gestendo ordine contanti...');
            console.log('Carrello attuale:', cart);
            console.log('Totale attuale:', cartTotal);
            
            if (cart.length === 0) {
                alert('Aggiungi almeno un prodotto al carrello prima di ordinare!');
                return;
            }
            
            const message = generateWhatsAppMessage();
            console.log('Messaggio da inviare:', message);
            
            const whatsappUrl = `https://wa.me/393478881515?text=${encodeURIComponent(message)}`;
            console.log('URL WhatsApp:', whatsappUrl);
            
            // Apri WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // Mostra conferma e chiudi modal
            setTimeout(() => {
                if (cartModal) cartModal.style.display = 'none';
                showToast('Ordine inviato su WhatsApp! üì±');
                
                // Non svuotare il carrello immediatamente, lasciamo che l'utente confermi
                if (confirm('Ordine inviato! Vuoi svuotare il carrello?')) {
                    clearCart();
                }
            }, 1000);
        }
        
        // Genera messaggio WhatsApp DETTAGLIATO
        function generateWhatsAppMessage() {
            const customerName = document.getElementById('customer-name')?.value || 'Cliente';
            const pickupDate = document.getElementById('pickup-date')?.value || 'Da definire';
            
            console.log('Generando messaggio con carrello:', cart);
            console.log('Totale carrello:', cartTotal);
            
            let message = `üçΩÔ∏è *Nuovo Ordine Pasto Sano*\n\n`;
            message += `üë§ Nome: ${customerName}\n`;
            message += `üìÖ Data ritiro: ${pickupDate}\n`;
            message += `üíµ Pagamento: Contanti alla consegna\n\n`;
            
            if (cart && cart.length > 0) {
                message += `üìã *Dettagli Ordine:*\n`;
                
                cart.forEach(item => {
                    const itemTotal = (item.quantity * item.price).toFixed(2);
                    message += `‚Ä¢ ${item.name}\n`;
                    message += `  Quantit√†: ${item.quantity} x ${item.price}‚Ç¨ = ${itemTotal}‚Ç¨\n\n`;
                });
                
                message += `üí∞ *Totale Ordine: ${cartTotal.toFixed(2)}‚Ç¨*\n\n`;
            } else {
                message += `‚ö†Ô∏è *Carrello vuoto*\n\n`;
            }
            
            message += `üì± Grazie per il tuo ordine!\n`;
            message += `Ti ricontatteremo per confermare i dettagli.`;
            
            console.log('Messaggio generato:', message);
            
            return message;
        }
        
        // Rendi le funzioni globali
        window.handleCashOrder = handleCashOrder;
        window.generateWhatsAppMessage = generateWhatsAppMessage;
    });
    </script>
</body>
</html>
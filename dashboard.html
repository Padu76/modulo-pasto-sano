<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pasto Sano - Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>

    <style>
        /* I tuoi stili personalizzati, come erano nel tuo HTML originale */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #2d3748;
        }

        .header {
            background: linear-gradient(135deg, #3f6844, #7a9e7e);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.2s ease-in-out;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .icon {
            font-size: 36px;
            color: #4CAF50; /* Green color for icons */
            margin-bottom: 15px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 16px;
            color: #666;
        }

        .dashboard-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            color: #4a5568;
            background-color: #edf2f7;
            margin-right: 5px;
        }

        .tab-button.active {
            background-color: #4CAF50; /* Green active tab */
            color: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }

        .tab-button:hover:not(.active) {
            background-color: #e2e8f0;
        }

        .tab-content {
            /* Handled by hidden class in JS */
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th, .data-table td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background-color: #f8f8f8;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            font-size: 14px;
        }

        .data-table tr:hover {
            background-color: #f0f4f8;
        }

        .status-pill {
            padding: 4px 8px;
            border-radius: 9999px; /* Full pill shape */
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .status-delivered {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }

        .status-pending {
            background-color: #fef3c7; /* yellow-100 */
            color: #92400e; /* yellow-800 */
        }

        .status-in-transit {
            background-color: #bfdbfe; /* blue-100 */
            color: #1e40af; /* blue-800 */
        }

        .status-cancelled {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #888;
        }

        .modal-close-button:hover {
            color: #333;
        }

        .chart-container {
            position: relative;
            height: 400px; /* Altezza fissa per il grafico */
            width: 100%;
            margin-top: 20px;
        }

        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            font-weight: bold;
            opacity: 0; /* Inizialmente nascosta */
            transform: translateY(-20px); /* Inizialmente spostata in su */
        }

        /* Animazione per le notifiche */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInOut {
            animation: fadeInOut 5s forwards;
        }

        #error-message {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            display: none; /* Nascondi di default */
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="container flex justify-between items-center">
            <div>
                <h1>Dashboard Amministrativa</h1>
                <p>Panoramica delle statistiche e degli ordini</p>
            </div>
            <img src="https://pastosano.netlify.app/img/logo-white.png" alt="Pasto Sano Logo" class="h-12">
        </div>
    </div>

    <div class="container mt-8">
        <div id="error-message" class="hidden"></div>

        <div id="notification" class="hidden"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon"><i class="fas fa-utensils"></i></div>
                <div class="value" id="today-orders">0</div>
                <div class="label">Ordini Oggi</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-euro-sign"></i></div>
                <div class="value" id="today-revenue">€0.00</div>
                <div class="label">Fatturato Oggi</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-clock"></i></div>
                <div class="value" id="pending-orders">0</div>
                <div class="label">Ordini in Elaborazione</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-star"></i></div>
                <div class="value" id="customer-satisfaction">0 / 5</div>
                <div class="label">Soddisfazione Clienti</div>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="tabs">
                <button class="tab-button active" data-target="overview">Panoramica</button>
                <button class="tab-button" data-target="orders">Ordini</button>
                <button class="tab-button" data-target="products">Prodotti</button>
                <button class="tab-button" data-target="sales">Vendite</button>
            </div>

            <div id="overview" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Panoramica Generale</h2>
                <p class="text-gray-600">Visualizza le statistiche chiave del tuo business.</p>
                <div class="mt-8 p-6 bg-green-50 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold mb-3 text-green-700">Consigli per Oggi</h3>
                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                        <li>Controlla lo stato degli ordini in preparazione.</li>
                        <li>Assicurati che le consegne siano in orario.</li>
                        <li>Prepara i documenti di produzione per gli ordini imminenti.</li>
                    </ul>
                </div>
            </div>

            <div id="orders" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Gestione Ordini</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Orario</th>
                                <th>Stato</th>
                                <th>Totale</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="products" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Prodotti più Venduti</h2>
                <ul id="top-products-list" class="space-y-4">
                    </ul>
            </div>

            <div id="sales" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Andamento Vendite</h2>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="order-details-modal" class="modal hidden">
        <div class="modal-content">
            <span class="modal-close-button" id="close-order-modal">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Dettagli Ordine</h2>
            <div class="space-y-3 text-gray-700">
                <p><strong>Cliente:</strong> <span id="modal-customer-name"></span></p>
                <p><strong>Orario:</strong> <span id="modal-order-time"></span></p>
                <p><strong>Stato:</strong> <span id="modal-order-status" class="font-semibold"></span></p>
                <div class="border-t border-b py-2 my-2">
                    <h3 class="font-semibold text-lg mb-2 text-gray-800">Articoli:</h3>
                    <ul id="modal-order-items" class="list-none p-0">
                        </ul>
                </div>
                <p class="text-right font-bold text-lg">Totale: <span id="modal-order-total"></span></p>
            </div>
        </div>
    </div>

    <script>
        // TUTTO IL CODICE JAVASCRIPT È INCLUSO QUI

        document.addEventListener('DOMContentLoaded', async () => {
            // STATO GLOBALE E DATI MOCK
            let allOrders = []; // Array per tutti gli ordini, caricati o mock
            let lastOrderCount = 0; // Per tenere traccia del numero di ordini per le notifiche
            let topProductsData = [];
            let salesChart = null; // Chart.js instance

            // Funzione per generare un ID univoco (semplice, per mock)
            function generateUniqueId() {
                return '_' + Math.random().toString(36).substr(2, 9);
            }

            // Funzione per generare ordini mock
            function getMockOrders() {
                const mockOrders = [
                    {
                        id: generateUniqueId(),
                        customer: 'Mario Rossi',
                        time: '12:30',
                        status: 'Consegnato',
                        items: [{ name: 'Spaghetti al Ragù', quantity: 1, price: 12.50 }],
                        total: 12.50
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Giulia Bianchi',
                        time: '13:00',
                        status: 'In preparazione',
                        items: [
                            { name: 'Pizza Margherita', quantity: 1, price: 8.00 },
                            { name: 'Coca-Cola', quantity: 1, price: 3.00 }
                        ],
                        total: 11.00
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Luca Verdi',
                        time: '13:15',
                        status: 'In transito',
                        items: [{ name: 'Insalata Greca', quantity: 1, price: 9.50 }],
                        total: 9.50
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Anna Neri',
                        time: '13:30',
                        status: 'Consegnato',
                        items: [
                            { name: 'Lasagne al Forno', quantity: 1, price: 13.00 },
                            { name: 'Acqua Naturale', quantity: 1, price: 2.00 }
                        ],
                        total: 15.00
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Marco Gialli',
                        time: '14:00',
                        status: 'In preparazione',
                        items: [{ name: 'Ravioli di Zucca', quantity: 1, price: 14.00 }],
                        total: 14.00
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Sara Blu',
                        time: '14:15',
                        status: 'Consegnato',
                        items: [
                            { name: 'Cotoletta alla Milanese', quantity: 1, price: 16.00 },
                            { name: 'Patatine Fritte', quantity: 1, price: 4.00 }
                        ],
                        total: 20.00
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Paolo Rossi',
                        time: '14:30',
                        status: 'In preparazione',
                        items: [{ name: 'Pizza Diavola', quantity: 1, price: 9.00 }],
                        total: 9.00
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Chiara Bianchi',
                        time: '15:00',
                        status: 'Annullato',
                        items: [{ name: 'Risotto ai Funghi', quantity: 1, price: 13.50 }],
                        total: 13.50
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Davide Verdi',
                        time: '15:15',
                        status: 'Consegnato',
                        items: [{ name: 'Hamburger XL', quantity: 1, price: 11.00 }],
                        total: 11.00
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Elena Neri',
                        time: '15:30',
                        status: 'In transito',
                        items: [
                            { name: 'Kebab Completo', quantity: 1, price: 7.50 },
                            { name: 'Tiramisù', quantity: 1, price: 5.00 }
                        ],
                        total: 12.50
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Federico Gialli',
                        time: '16:00',
                        status: 'In preparazione',
                        items: [{ name: 'Sushi Misto (12pz)', quantity: 1, price: 22.00 }],
                        total: 22.00
                    },
                    {
                        id: generateUniqueId(),
                        customer: 'Giorgia Blu',
                        time: '16:15',
                        status: 'Consegnato',
                        items: [{ name: 'Poke Bowl Salmone', quantity: 1, price: 15.00 }],
                        total: 15.00
                    }
                ];
                return mockOrders;
            }

            // Funzione per simulare il caricamento dei dati (potrebbe essere una fetch API reale in futuro)
            async function loadAllData() {
                console.log('⏳ Caricamento dati...');
                try {
                    // Qui in futuro ci sarebbe la chiamata API reale
                    // const response = await fetch('/api/orders');
                    // if (!response.ok) throw new Error('Errore nel caricamento degli ordini');
                    // allOrders = await response.json();
                    allOrders = getMockOrders(); // Usiamo i mock per ora
                    lastOrderCount = allOrders.length; // Inizializza contatore
                    console.log('✅ Dati caricati:', allOrders);
                } catch (error) {
                    showError(`Impossibile caricare i dati: ${error.message}. Caricamento dati mock.`);
                    allOrders = getMockOrders(); // Carica i dati mock in caso di errore
                    lastOrderCount = allOrders.length; // Inizializza contatore
                }
            }

            // AGGIORNA STATISTICHE (Overview Tab)
            function updateStats() {
                const todayOrders = allOrders.filter(order => order.status !== 'Annullato').length;
                const todayRevenue = allOrders.filter(order => order.status !== 'Annullato').reduce((sum, order) => sum + order.total, 0);
                const pendingOrders = allOrders.filter(order => order.status === 'In preparazione' || order.status === 'In transito').length;

                document.getElementById('today-orders').textContent = todayOrders;
                document.getElementById('today-revenue').textContent = `€${todayRevenue.toFixed(2)}`;
                document.getElementById('pending-orders').textContent = pendingOrders;
                document.getElementById('customer-satisfaction').textContent = '4.8 / 5'; // Placeholder
            }

            // VISUALIZZA ORDINI (Orders Tab)
            function displayOrders() {
                const ordersTableBody = document.getElementById('orders-table-body');
                if (!ordersTableBody) {
                    console.error('Elemento orders-table-body non trovato.');
                    return;
                }
                ordersTableBody.innerHTML = ''; // Pulisci la tabella

                allOrders.forEach(order => {
                    const row = ordersTableBody.insertRow();
                    row.className = 'border-b hover:bg-gray-50';

                    row.insertCell().textContent = order.customer;
                    row.insertCell().textContent = order.time;
                    const statusCell = row.insertCell();
                    statusCell.textContent = order.status;
                    statusCell.className = getStatusClass(order.status); // Applica classe CSS per colore

                    row.insertCell().textContent = `€${order.total.toFixed(2)}`;

                    const actionsCell = row.insertCell();
                    const viewButton = document.createElement('button');
                    viewButton.textContent = 'Dettagli';
                    viewButton.className = 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm mr-2';
                    viewButton.onclick = () => showOrderDetails(order);
                    actionsCell.appendChild(viewButton);

                    const productionButton = document.createElement('button');
                    productionButton.textContent = 'Produzione';
                    productionButton.className = 'bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm';
                    productionButton.onclick = () => generateProductionDocument([order]); // Passa un array con un solo ordine
                    actionsCell.appendChild(productionButton);
                });
            }

            function getStatusClass(status) {
                switch (status) {
                    case 'Consegnato':
                        return 'text-green-600 font-semibold';
                    case 'In preparazione':
                        return 'text-yellow-600 font-semibold';
                    case 'In transito':
                        return 'text-blue-600 font-semibold';
                    case 'Annullato':
                        return 'text-red-600 font-semibold';
                    default:
                        return '';
                }
            }

            // MOSTRA DETTAGLI ORDINE (MODAL)
            function showOrderDetails(order) {
                document.getElementById('modal-customer-name').textContent = order.customer;
                document.getElementById('modal-order-time').textContent = order.time;
                document.getElementById('modal-order-status').textContent = order.status;
                document.getElementById('modal-order-status').className = getStatusClass(order.status);

                const modalItemsList = document.getElementById('modal-order-items');
                modalItemsList.innerHTML = '';
                order.items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between text-gray-700';
                    li.innerHTML = `<span><span class="math-inline">\{item\.name\} x</span>{item.quantity}</span><span>€${(item.price * item.quantity).toFixed(2)}</span>`;
                    modalItemsList.appendChild(li);
                });

                document.getElementById('modal-order-total').textContent = `€${order.total.toFixed(2)}`;

                document.getElementById('order-details-modal').classList.remove('hidden');
            }

            document.getElementById('close-order-modal').onclick = () => {
                document.getElementById('order-details-modal').classList.add('hidden');
            };

            // AGGIORNA I PRODOTTI PIÙ VENDUTI (Products Tab)
            function updateTopProducts() {
                const productSales = {};
                allOrders.forEach(order => {
                    order.items.forEach(item => {
                        if (productSales[item.name]) {
                            productSales[item.name] += item.quantity;
                        } else {
                            productSales[item.name] = item.quantity;
                        }
                    });
                });

                topProductsData = Object.entries(productSales)
                    .sort(([, countA], [, countB]) => countB - countA)
                    .slice(0, 5); // Prendi i primi 5

                const topProductsList = document.getElementById('top-products-list');
                if (!topProductsList) {
                    console.error('Elemento top-products-list non trovato.');
                    return;